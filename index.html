<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTRVX ALTO XML Validator</title>
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .console {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 20px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .console-line {
            display: block;
            margin: 2px 0;
        }
        .success-line {
            color: #28a745;
        }
        .success-line::before {
            content: "✓ ";
            color: #28a745;
        }
        .error-line {
            color: #dc3545;
        }
        .error-line::before {
            content: "✕ ";
            color: #dc3545;
        }
        .info-line {
            color: #0056b3;
        }
        .info-line::before {
            content: "ℹ ";
            color: #0056b3;
        }
        .summary-panel {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }
        .summary-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .summary-stats {
            display: flex;
            gap: 20px;
        }
        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            flex: 1;
        }
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }
        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner.active {
            display: block;
        }
        button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>HTRVX ALTO XML Validator</h1>
    
    <div class="summary-panel">
        <div class="summary-title">Validation Summary</div>
        <div class="summary-stats">
            <div class="stat-item">
                <div class="stat-label">Total Files</div>
                <div class="stat-value" id="totalFiles">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Valid Files</div>
                <div class="stat-value" id="validFiles">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Files with Errors</div>
                <div class="stat-value" id="errorFiles">-</div>
            </div>
        </div>
    </div>

    <p>Upload a ZIP file containing ALTO XML files to validate:</p>
    
    <input type="file" id="zipFile" accept=".zip" />
    <button id="validateBtn">Validate</button>
    
    <div class="spinner" id="spinner"></div>
    <div id="status"></div>
    <div id="console" class="console"></div>

    <script>
        let validFileCount = 0;
        let totalFileCount = 0;
        let errorFileCount = 0;

        function updateSummary() {
            document.getElementById('totalFiles').textContent = totalFileCount;
            document.getElementById('validFiles').textContent = validFileCount;
            document.getElementById('errorFiles').textContent = errorFileCount;
        }

        function appendToConsole(text, type = '') {
            const console = document.getElementById('console');
            const line = document.createElement('span');

            // Parse ANSI codes and replace them with HTML elements
            const ansiRegex = /\[(\d+)m/g;
            let match;
            let lastIndex = 0;
            let result = '';

            while ((match = ansiRegex.exec(text)) !== null) {
                const code = match[1];
                const before = text.substring(lastIndex, match.index);
                result += before;

                switch (code) {
                    case '31': // Red text (error)
                        result += '<span class="error-line">';
                        break;
                    case '32': // Green text (success)
                        result += '<span class="success-line">';
                        break;
                    case '34': // Blue text (info)
                        result += '<span class="info-line">';
                        break;
                    case '0': // Reset
                        result += '</span>';
                        break;
                }

                lastIndex = ansiRegex.lastIndex;
            }

            result += text.substring(lastIndex);
            line.innerHTML = result;
            line.className = `console-line ${type}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function getResult() {
            const consoleLines = document.querySelectorAll(".console-line");
            const lastLine = consoleLines[consoleLines.length - 1];

            if (lastLine) {
                const text = lastLine.textContent;
                const match = text.match(/^(\d+)\/(\d+) valid XML files$/);

                console.log("hello c'est moi 2")

                if (match) {
                    console.log("hello c'est moi 2")
                validFileCount = parseInt(match[1], 10);
                totalFileCount = parseInt(match[2], 10);
                errorFileCount = totalFileCount - validFileCount;
                updateSummary()
            } else {
                console.error("Impossible to get result about process analysis");
        }
    }}

        async function loadPyodideScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js";
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Pyodide script'));
                document.head.appendChild(script);
            });
        }

        async function main() {
            const validateBtn = document.getElementById('validateBtn');
            const spinner = document.getElementById('spinner');
            const status = document.getElementById('status');
            const console = document.getElementById('console');
            
            validateBtn.disabled = true;
            spinner.classList.add('active');
            
            try {
                await loadPyodideScript();
                appendToConsole('Pyodide script loaded successfully', 'success-line');

                const pyodide = await loadPyodide({
                    stdout: (text) => appendToConsole(text)
                });
                appendToConsole('Pyodide initialized', 'success-line');
                
                await pyodide.loadPackage(['micropip']);
                appendToConsole('Installing dependencies...', 'info-line');
                
                await pyodide.runPythonAsync(`
                    import micropip
                    print("Installing pip and wheel...") 
                    await micropip.install('pip')
                    await micropip.install('wheel')
                    print("Installing lxml...")
                    await micropip.install('lxml')
                    print("Installing htrvx...")
                    await micropip.install('htrvx')
                `);
                
                appendToConsole('HTRVX and dependencies installed', 'success-line');
                validateBtn.disabled = false;
                spinner.classList.remove('active');
                
                validateBtn.addEventListener('click', async () => {
                    const fileInput = document.getElementById('zipFile');
                    
                    if (!fileInput.files.length) {
                        appendToConsole('Please upload a ZIP file.', 'error-line');
                        return;
                    }
                    
                    // Reset counters
                    validFileCount = 0;
                    errorFileCount = 0;
                    totalFileCount = 0;
                    updateSummary();
                    
                    validateBtn.disabled = true;
                    spinner.classList.add('active');
                    console.textContent = '';
                    appendToConsole('Validating files...', 'info-line');
                    
                    try {
                        const file = fileInput.files[0];
                        const arrayBuffer = await file.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        try {
                            pyodide.FS.unlink('uploaded.zip');
                            pyodide.FS.rmdir('extracted', { recursive: true });
                        } catch (e) {}

                        pyodide.FS.mkdir('extracted');
                        pyodide.FS.writeFile('uploaded.zip', uint8Array);
                        
                        const result = await pyodide.runPythonAsync(`
                            import zipfile
                            import os
                            from htrvx.testing import test
                            
                            with zipfile.ZipFile("uploaded.zip", "r") as zip_ref:
                                zip_ref.extractall("extracted")
                            
                            xml_files = [
                                os.path.join(root, fname)
                                for root, _, files in os.walk("extracted")
                                for fname in files if fname.endswith('.xml') and fname.lower() != "mets.xml"
                            ]
                            
                            if not xml_files:
                                print("✕ No XML files found in ZIP", flush=True)
                                files_processed = 0
                            else:
                                success, messages = test(
                                    xml_files,
                                    verbose="zen",
                                    group=True,
                                    format="alto",
                                    segmonto=True,
                                    check_empty=True,
                                    raise_empty=True,
                                    xsd=True,
                                    verbose_level="all",
                                    check_image=False
                                )
                                files_processed = len(xml_files)
                            
                            files_processed
                        `);
                        
                        totalFileCount = result;
                        getResult();
                        appendToConsole(`Validation complete: Processed ${result} files`, 'success-line');
                    } catch (error) {
                        appendToConsole(`Error during validation: ${error.message}`, 'error-line');
                    } finally {
                        validateBtn.disabled = false;
                        spinner.classList.remove('active');
                    }
                });
                
            } catch (error) {
                appendToConsole(`Failed to initialize: ${error.message}`, 'error-line');
                spinner.classList.remove('active');
            }
        }
        
        main();
    </script>
</body>
</html>
